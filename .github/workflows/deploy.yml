# .github/workflows/debug-ssh.yml
name: Debug SSH

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
    - name: Save and test SSH key
      run: |
        # Зберегти ключ у файл
        echo "${{ secrets.AWS_SSH_KEY }}" > test_key
        chmod 600 test_key
        
        # Перевірити ключ
        echo "=== Перевірка ключа ==="
        ssh-keygen -l -f test_key
        
        # Перевірити підключення
        echo "=== Тест підключення ==="
        timeout 30 ssh -i test_key \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=10 \
          ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} \
          "echo '✅ SSH працює! Хост: \$(hostname)'" || \
          echo "❌ SSH не працює"
        
        # Показати деталі помилки
        echo "=== Детальний тест ==="
        ssh -i test_key \
          -o StrictHostKeyChecking=no \
          -v \
          ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} \
          "echo test" 2>&1 | tail -20
      env:
        AWS_HOST: ${{ secrets.AWS_HOST }}
        AWS_USER: ${{ secrets.AWS_USER }}
        AWS_SSH_KEY: ${{ secrets.AWS_SSH_KEY }}
