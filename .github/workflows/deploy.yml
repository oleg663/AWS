name: Deploy Medical Website

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.AWS_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
    
    - name: Fix permissions on server
      run: |
        ssh -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} \
          "sudo chown -R ${{ secrets.AWS_USER }}:${{ secrets.AWS_USER }} /var/www/my-site && \
           sudo chmod -R 775 /var/www/my-site"
    
    - name: Deploy medical website files
      run: |
        # –ö–æ–ø—ñ—é—î–º–æ —Ñ–∞–π–ª–∏ –ø–æ –æ–¥–Ω–æ–º—É
        FILES="index.html about.html css js assets"
        
        for item in $FILES; do
          if [ -d "$item" ] || [ -f "$item" ]; then
            echo "–ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è $item..."
            scp -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -r "$item" \
              ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }}:/var/www/my-site/ || echo "–ü–æ–º–∏–ª–∫–∞ –∑ $item"
          fi
        done
    
    - name: Set final permissions for nginx
      run: |
        ssh -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} \
          "sudo chown -R www-data:www-data /var/www/my-site && \
           sudo find /var/www/my-site -type f -exec chmod 644 {} \; && \
           sudo find /var/www/my-site -type d -exec chmod 755 {} \; && \
           sudo systemctl reload nginx"
    
    - name: Verify deployment
      run: |
        echo "‚úÖ –ú–µ–¥–∏—á–Ω–∏–π —Å–∞–π—Ç –∑–∞–¥–µ–ø–ª–æ—î–Ω–æ!"
        echo "üåê –í—ñ–¥–∫—Ä–∏–π—Ç–µ: http://${{ secrets.AWS_HOST }}"
        echo "üè• –¢–µ–º–∞: –ü–µ—Ä—à–∞ –º–µ–¥–∏—á–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞"
