name: Deploy to AWS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install HTML validator
      run: |
        npm install -g html-validator-cli
        
    - name: Validate HTML files
      run: |
        echo "Validating HTML files..."
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ index.html
        if html-validator --file ./index.html --verbose; then
          echo "‚úÖ index.html is valid"
        else
          echo "‚ùå index.html has errors"
          exit 1
        fi
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ about.html
        if html-validator --file ./about.html --verbose; then
          echo "‚úÖ about.html is valid"
        else
          echo "‚ùå about.html has errors"
          exit 1
        fi

    - name: Check for broken links
      run: |
        echo "Installing link checker..."
        sudo apt-get update
        sudo apt-get install -y linkchecker
        
        echo "Checking internal links..."
        # –¢—ñ–ª—å–∫–∏ –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
        linkchecker --check-extern=no index.html || echo "Link check completed"

  deploy:
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to AWS EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.AWS_HOST }}
        username: ${{ secrets.AWS_USER }}
        key: ${{ secrets.AWS_SSH_KEY }}
        source: "./"
        target: "/var/www/my-site"
        strip_components: 1
    
    - name: Set correct permissions
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.AWS_HOST }}
        username: ${{ secrets.AWS_USER }}
        key: ${{ secrets.AWS_SSH_KEY }}
        script: |
          echo "Setting permissions..."
          sudo chown -R www-data:www-data /var/www/my-site
          sudo chmod -R 755 /var/www/my-site
          sudo systemctl reload nginx
          
          # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —â–æ —Ñ–∞–π–ª–∏ –Ω–∞ –º—ñ—Å—Ü—ñ
          echo "Files in /var/www/my-site:"
          ls -la /var/www/my-site/
          
          # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —â–æ nginx –ø—Ä–∞—Ü—é—î
          echo "Nginx status:"
          sudo systemctl status nginx --no-pager
    
    - name: Send success notification
      if: success()
      run: |
        echo "üöÄ –î–µ–ø–ª–æ–π —É—Å–ø—ñ—à–Ω–∏–π!"
        echo "–°–∞–π—Ç –¥–æ—Å—Ç—É–ø–Ω–∏–π –∑–∞ –∞–¥—Ä–µ—Å–æ—é: http://${{ secrets.AWS_HOST }}"
        echo "–ß–∞—Å –¥–µ–ø–ª–æ—é: $(date)"
    
    - name: Send failure notification
      if: failure()
      run: |
        echo "‚ùå –î–µ–ø–ª–æ–π –Ω–µ –≤–¥–∞–≤—Å—è!"
        echo "–ü–µ—Ä–µ–≤—ñ—Ä –ª–æ–≥–∏ –≤–∏—â–µ"
        exit 1
