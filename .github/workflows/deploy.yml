name: Deploy CI/CD Site

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.AWS_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
    
    - name: Deploy files (simple scp)
      run: |
        # –ö–æ–ø—ñ—é—î–º–æ —Ç—ñ–ª—å–∫–∏ –ø–æ—Ç—Ä—ñ–±–Ω—ñ —Ñ–∞–π–ª–∏
        scp -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          index.html \
          ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }}:/var/www/my-site/
        
        scp -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          about.html \
          ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }}:/var/www/my-site/
        
        # CSS –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è
        scp -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          -r css/ \
          ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }}:/var/www/my-site/
        
        # JS –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è  
        scp -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          -r js/ \
          ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }}:/var/www/my-site/
    
    - name: Set final permissions
      run: |
        ssh -i ~/.ssh/deploy_key \
          -o StrictHostKeyChecking=no \
          ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} \
          "sudo chown -R www-data:www-data /var/www/my-site && \
           sudo find /var/www/my-site -type f -exec chmod 644 {} \; && \
           sudo find /var/www/my-site -type d -exec chmod 755 {} \; && \
           sudo systemctl reload nginx"
    
    - name: Verify
      run: |
        echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
        echo "üåê –°–∞–π—Ç: http://${{ secrets.AWS_HOST }}"
        echo "üìÅ –§–∞–π–ª–∏: /var/www/my-site/"
